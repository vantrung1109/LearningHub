<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dev Knowledge Hub â€” 1 file</title>
  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Marked: Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- DOMPurify: sanitize HTML from markdown -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.7/dist/purify.min.js"></script>
  <style>
    /* line-clamp fallback */
    .line-clamp-6 {
      display: -webkit-box;
      -webkit-line-clamp: 6;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    dialog[open]::backdrop { background: rgba(0,0,0,.25); }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-white text-slate-900">
  <div class="h-screen flex">

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 border-r bg-white/60 backdrop-blur supports-[backdrop-filter]:bg-white/40 transition-all">
      <div class="flex items-center justify-between p-3">
        <div class="text-lg font-semibold">Knowledge</div>
        <button id="toggleSidebar" class="p-2 rounded hover:bg-slate-100" title="Thu gá»n">â´</button>
      </div>

      <div class="px-2">
        <button data-filter="all" class="w-full flex items-center justify-between px-3 py-2 rounded hover:bg-slate-100 filter-btn">
          <span class="flex items-center gap-2">ğŸ“š All</span>
          <span id="count-all" class="text-xs px-2 py-0.5 bg-slate-200 rounded">0</span>
        </button>
      </div>

      <div class="mt-2 space-y-1 px-2">
        <button data-filter="android" class="w-full flex items-center justify-between px-3 py-2 rounded hover:bg-slate-100 filter-btn">
          <span class="flex items-center gap-2">ğŸ¤– Android</span>
          <span id="count-android" class="text-xs px-2 py-0.5 bg-slate-200 rounded">0</span>
        </button>
        <button data-filter="kotlin" class="w-full flex items-center justify-between px-3 py-2 rounded hover:bg-slate-100 filter-btn">
          <span class="flex items-center gap-2">ğŸ§© Kotlin</span>
          <span id="count-kotlin" class="text-xs px-2 py-0.5 bg-slate-200 rounded">0</span>
        </button>
        <button data-filter="compose" class="w-full flex items-center justify-between px-3 py-2 rounded hover:bg-slate-100 filter-btn">
          <span class="flex items-center gap-2">ğŸ“˜ Jetpack Compose</span>
          <span id="count-compose" class="text-xs px-2 py-0.5 bg-slate-200 rounded">0</span>
        </button>
      </div>

      <div class="mt-6 px-3 text-xs text-slate-500">
        Tip: dá»¯ liá»‡u lÆ°u trong trÃ¬nh duyá»‡t (localStorage).
      </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col overflow-hidden">
      <!-- Top bar -->
      <header class="flex items-center justify-between border-b bg-white/70 px-4 py-3 backdrop-blur supports-[backdrop-filter]:bg-white/40">
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2">ğŸ”</span>
          <input id="search" class="pl-9 w-72 border rounded px-3 py-2" placeholder="Search title, content, tagsâ€¦" />
        </div>
        <div class="flex items-center gap-2">
          <input id="importInput" type="file" accept=".md,.markdown,.txt" class="hidden" />
          <button id="importBtn" class="px-3 py-2 border rounded hover:bg-slate-100">â¬†ï¸ Import .md</button>
          <button id="newBtn" class="px-3 py-2 bg-slate-900 text-white rounded hover:opacity-90">â• New note</button>
        </div>
      </header>

      <!-- Content -->
      <section class="flex-1 p-4 overflow-auto">
        <div id="empty" class="hidden h-64 text-slate-500 flex items-center justify-center">
          ChÆ°a cÃ³ ghi chÃº. Báº¥m â€œNew noteâ€ Ä‘á»ƒ thÃªm.
        </div>

        <div id="grid" class="grid grid-cols-1 gap-4 md:grid-cols-2 xl:grid-cols-3"></div>
      </section>
    </main>
  </div>

  <!-- Editor dialog -->
  <dialog id="editor" class="rounded-xl w-[min(720px,92vw)] border p-0">
    <form method="dialog">
      <div class="p-4 border-b">
        <h3 id="editorTitle" class="text-lg font-semibold">Add a new note</h3>
      </div>

      <div class="p-4 space-y-4">
        <div>
          <label class="text-sm font-medium">Title</label>
          <input id="f-title" class="w-full mt-1 border rounded px-3 py-2" placeholder="e.g. Debounce search with Flow" />
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-medium">Section</label>
            <select id="f-section" class="w-full mt-1 border rounded px-3 py-2">
              <option value="android">Android</option>
              <option value="kotlin">Kotlin</option>
              <option value="compose">Jetpack Compose</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-medium">Tags (comma separated)</label>
            <input id="f-tags" class="w-full mt-1 border rounded px-3 py-2" placeholder="Flow, MVVM, Hilt" />
          </div>
        </div>

        <div class="flex items-center justify-between">
          <span class="text-sm font-medium">Markdown</span>
          <div class="flex items-center gap-2">
            <input id="editorUpload" type="file" accept=".md,.markdown,.txt" class="hidden" />
            <button id="editorUploadBtn" type="button" class="px-3 py-2 border rounded hover:bg-slate-100">â¬†ï¸ Upload .md</button>
          </div>
        </div>

        <div class="border rounded overflow-hidden">
          <div class="flex border-b">
            <button id="tabWrite" type="button" class="px-4 py-2 text-sm border-r bg-slate-100">Write</button>
            <button id="tabPreview" type="button" class="px-4 py-2 text-sm">Preview</button>
          </div>
          <textarea id="f-content" rows="12" class="w-full p-3 outline-none" placeholder="# Title

Write your note in **Markdown** here..."></textarea>
          <div id="preview" class="hidden p-4 prose max-w-none"></div>
        </div>
      </div>

      <div class="p-4 border-t flex items-center justify-end gap-2">
        <button id="cancelBtn" class="px-3 py-2 border rounded">Cancel</button>
        <button id="saveBtn" class="px-3 py-2 bg-slate-900 text-white rounded">ğŸ’¾ Save</button>
      </div>
    </form>
  </dialog>

  <script>
    // ---------- Data & utils ----------
    const STORAGE_KEY = "dev-notes-v1";
    const SECTIONS = ["android","kotlin","compose"];
    let notes = [];
    let filter = "all";
    let query = "";
    let editingId = null;

    function uid() {
      return Math.random().toString(36).slice(2) + Date.now().toString(36);
    }
    function now() { return Date.now(); }
    function fmt(ts) { return new Date(ts).toLocaleString(); }

    function parseTitleFromMarkdown(md) {
      const lines = md.split(/\r?\n/);
      for (const line of lines) {
        const m = line.match(/^\s*#\s*(.+)$/);
        if (m) return m[1].trim();
      }
      const first = lines.find(l => l.trim().length) || "Untitled";
      return first.slice(0, 80);
    }

    function loadNotes() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
      } catch {}
      const seed = [
        {
          id: uid(),
          title: "MVVM: ViewModel, Repository, DI",
          section: "android",
          content: "# MVVM\n\nTÃ¡ch táº§ng: UI (Compose/Views) â†” ViewModel (state/Flow) â†” Repository (business) â†” DataSource (network/db). Dagger/Hilt cung cáº¥p phá»¥ thuá»™c. DistinctUntilChanged cho state.",
          tags: ["MVVM","Dagger","Architecture"],
          updatedAt: now() - 1000*60*60*24*3
        },
        {
          id: uid(),
          title: "Kotlin Flow: debounce vs buffer",
          section: "kotlin",
          content: "# Kotlin Flow: debounce vs buffer\n\n`debounce()` Ä‘á»ƒ chá» ngÆ°á»i dÃ¹ng dá»«ng gÃµ trÆ°á»›c khi query. `buffer()` Ä‘á»ƒ khÃ´ng block emitter khi collector cháº­m. `mapLatest()` há»§y job cÅ© khi cÃ³ input má»›i.",
          tags: ["Flow","Coroutines"],
          updatedAt: now() - 1000*60*60*18
        },
        {
          id: uid(),
          title: "Compose: State hoisting",
          section: "compose",
          content: "# Compose: State hoisting\n\nÄáº©y state ra ngoÃ i Composable con qua tham sá»‘ (value, onValueChange). DÃ¹ng `remember`/`rememberSaveable` há»£p lÃ½. `derivedStateOf` cho tÃ­nh toÃ¡n Ä‘áº¯t Ä‘á».",
          tags: ["Compose","State"],
          updatedAt: now() - 1000*60*60*2
        }
      ];
      localStorage.setItem(STORAGE_KEY, JSON.stringify(seed));
      return seed;
    }
    function saveNotes() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/markdown;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    // ---------- Rendering ----------
    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");

    function renderCounts() {
      const cAll = notes.length;
      const cAndroid = notes.filter(n=>n.section==="android").length;
      const cKotlin = notes.filter(n=>n.section==="kotlin").length;
      const cCompose = notes.filter(n=>n.section==="compose").length;
      document.getElementById("count-all").textContent = cAll;
      document.getElementById("count-android").textContent = cAndroid;
      document.getElementById("count-kotlin").textContent = cKotlin;
      document.getElementById("count-compose").textContent = cCompose;
    }

    function renderList() {
      const q = query.trim().toLowerCase();
      let list = notes
        .filter(n => filter==="all" ? true : n.section===filter)
        .filter(n => {
          if (!q) return true;
          return n.title.toLowerCase().includes(q) ||
                 n.content.toLowerCase().includes(q) ||
                 n.tags.join(" ").toLowerCase().includes(q);
        })
        .sort((a,b)=>b.updatedAt - a.updatedAt);

      grid.innerHTML = "";
      if (list.length === 0) {
        empty.classList.remove("hidden");
        return;
      } else empty.classList.add("hidden");

      list.forEach(n => {
        const card = document.createElement("div");
        card.className = "group border rounded-xl bg-white shadow-sm hover:shadow transition";

        const header = document.createElement("div");
        header.className = "p-4 border-b";
        header.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="text-base font-semibold leading-tight">${n.title}</div>
            <div class="relative">
              <button class="px-2 py-1 rounded hover:bg-slate-100" title="Menu">â‹¯</button>
              <div class="hidden absolute right-0 mt-1 w-44 bg-white border rounded shadow menu">
                <button class="w-full text-left px-3 py-2 hover:bg-slate-100 btn-edit">âœï¸ Edit</button>
                <button class="w-full text-left px-3 py-2 hover:bg-slate-100 btn-download">â¬‡ï¸ Download .md</button>
                <button class="w-full text-left px-3 py-2 text-red-600 hover:bg-slate-100 btn-delete">ğŸ—‘ï¸ Delete</button>
              </div>
            </div>
          </div>
          <div class="mt-2 flex flex-wrap gap-1 text-xs">
            <span class="px-2 py-0.5 border rounded capitalize">${n.section}</span>
            ${n.tags.map(t=>`<span class="px-2 py-0.5 bg-slate-200 rounded">${t}</span>`).join("")}
          </div>
        `;
        card.appendChild(header);

        const body = document.createElement("div");
        body.className = "p-4";
        body.innerHTML = `<p class="line-clamp-6 whitespace-pre-wrap text-sm leading-relaxed">${n.content}</p>`;
        card.appendChild(body);

        const footer = document.createElement("div");
        footer.className = "px-4 py-2 border-t text-xs text-slate-500";
        footer.textContent = "Updated " + fmt(n.updatedAt);
        card.appendChild(footer);

        // menu logic
        const menuBtn = header.querySelector("button");
        const menu = header.querySelector(".menu");
        menuBtn.addEventListener("click", (e)=>{
          e.stopPropagation();
          menu.classList.toggle("hidden");
        });
        document.addEventListener("click", ()=> menu.classList.add("hidden"));

        // actions
        header.querySelector(".btn-edit").addEventListener("click", ()=> openEditor(n));
        header.querySelector(".btn-delete").addEventListener("click", ()=>{
          notes = notes.filter(x=>x.id!==n.id);
          saveNotes(); renderCounts(); renderList();
        });
        header.querySelector(".btn-download").addEventListener("click", ()=>{
          const titleHeader = n.title.startsWith("#") ? n.title : "# " + n.title;
          const meta = n.tags.length ? `\n\n> Tags: ${n.tags.join(", ")}` : "";
          downloadText(`${n.title.replace(/[^a-z0-9-_ ]/gi,"_")}.md`, `${titleHeader}\n\n${n.content}${meta}\n`);
        });

        grid.appendChild(card);
      });
    }

    // ---------- Editor ----------
    const dlg = document.getElementById("editor");
    const editorTitle = document.getElementById("editorTitle");
    const fTitle = document.getElementById("f-title");
    const fSection = document.getElementById("f-section");
    const fTags = document.getElementById("f-tags");
    const fContent = document.getElementById("f-content");
    const preview = document.getElementById("preview");
    const tabWrite = document.getElementById("tabWrite");
    const tabPreview = document.getElementById("tabPreview");
    const editorUpload = document.getElementById("editorUpload");
    const editorUploadBtn = document.getElementById("editorUploadBtn");

    function openEditor(n) {
      const isEdit = !!n;
      editorTitle.textContent = isEdit ? "Edit note" : "Add a new note";
      editingId = isEdit ? n.id : null;
      fTitle.value = isEdit ? n.title : "";
      fSection.value = isEdit ? n.section : (filter==="all" ? "android" : filter);
      fTags.value = isEdit ? n.tags.join(", ") : "";
      fContent.value = isEdit ? n.content : "";

      // default to Write tab
      preview.classList.add("hidden");
      fContent.classList.remove("hidden");
      tabWrite.classList.add("bg-slate-100");
      tabPreview.classList.remove("bg-slate-100");

      dlg.showModal();
    }

    function saveEditor() {
      const title = (fTitle.value || "").trim() || parseTitleFromMarkdown(fContent.value);
      if (!title) return;

      const section = fSection.value;
      const tags = fTags.value.split(",").map(t=>t.trim()).filter(Boolean);
      const content = fContent.value;

      if (editingId) {
        notes = notes.map(n => n.id === editingId ? { ...n, title, section, tags, content, updatedAt: now() } : n);
      } else {
        notes = [{ id: uid(), title, section, tags, content, updatedAt: now() }, ...notes];
      }
      saveNotes(); renderCounts(); renderList();
      dlg.close();
    }

    // Upload MD inside editor
    editorUploadBtn.addEventListener("click", ()=> editorUpload.click());
    editorUpload.addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || "");
        fContent.value = text;
        if (!(fTitle.value || "").trim()) fTitle.value = parseTitleFromMarkdown(text);
        // switch to Preview
        tabPreview.click();
      };
      reader.readAsText(f);
      e.target.value = "";
    });

    tabWrite.addEventListener("click", ()=>{
      tabWrite.classList.add("bg-slate-100");
      tabPreview.classList.remove("bg-slate-100");
      preview.classList.add("hidden");
      fContent.classList.remove("hidden");
    });
    tabPreview.addEventListener("click", ()=>{
      tabPreview.classList.add("bg-slate-100");
      tabWrite.classList.remove("bg-slate-100");
      const raw = marked.parse(fContent.value || "");
      preview.innerHTML = DOMPurify.sanitize(raw);
      preview.classList.remove("hidden");
      fContent.classList.add("hidden");
    });

    // ---------- Top-level events ----------
    document.getElementById("newBtn").addEventListener("click", ()=> openEditor(null));
    document.getElementById("saveBtn").addEventListener("click", (e)=> { e.preventDefault(); saveEditor(); });
    document.getElementById("cancelBtn").addEventListener("click", (e)=> { e.preventDefault(); dlg.close(); });

    // filter buttons
    document.querySelectorAll(".filter-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        filter = btn.dataset.filter;
        renderCounts(); renderList();
      });
    });

    // search
    document.getElementById("search").addEventListener("input", (e)=>{
      query = e.target.value;
      renderList();
    });

    // import from top bar
    const importInput = document.getElementById("importInput");
    document.getElementById("importBtn").addEventListener("click", ()=> importInput.click());
    importInput.addEventListener("change", (e)=>{
      const f = e.target.files?.[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = String(reader.result || "");
        const title = parseTitleFromMarkdown(text);
        const sec = (filter==="all"? "android" : filter);
        notes = [{ id: uid(), title, section: sec, tags: [], content: text, updatedAt: now() }, ...notes];
        saveNotes(); renderCounts(); renderList();
      };
      reader.readAsText(f);
      e.target.value = "";
    });

    // collapse sidebar
    const sidebar = document.getElementById("sidebar");
    const toggleSidebar = document.getElementById("toggleSidebar");
    let collapsed = false;
    toggleSidebar.addEventListener("click", ()=>{
      collapsed = !collapsed;
      if (collapsed) {
        sidebar.style.width = "4rem";
        toggleSidebar.textContent = "âµ";
        // hide text labels (simple)
        sidebar.querySelectorAll("span").forEach((el, idx)=>{
          if (idx % 2 === 0) return; // keep emoji
          el.classList.toggle("hidden", true);
        });
      } else {
        sidebar.style.width = "16rem";
        toggleSidebar.textContent = "â´";
        sidebar.querySelectorAll("span").forEach((el, idx)=>{
          el.classList.toggle("hidden", false);
        });
      }
    });

    // init
    notes = loadNotes();
    renderCounts();
    renderList();
  </script>
</body>
</html>
